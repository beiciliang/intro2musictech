# 评估

评估音乐检索系统对于理解其在返回满足用户查询的相关结果方面的有效性至关重要。评估过程需要仔细考虑多个因素，并遵循以下几个关键步骤：

```{figure} ./img/eval_prediction.png
---
name: Prediction
---
```

1. **度量距离/相似度**：计算查询与数据库中所有项目之间的相似度或距离分数，以建立完整的排序。这包括：
    - 计算文本查询和数据库中所有音乐项目的嵌入
    - 使用适当的度量方法（如余弦相似度、欧氏距离或学习到的相似度函数）测量距离
    - 根据相似度分数对项目进行排序以创建排名列表
    - 必要时进行分数归一化以确保公平比较

2. **定义 Top K 阈值**：设置一个截断点 K，确定哪些项目被视为"已检索"。这个阈值非常关键，因为：
    - 它定义了评估的范围——只有排在前 K 位的项目会被分析
    - 它需要在过于严格（较小的 K）和过于宽松（较大的 K）之间取得平衡
    - 它应反映真实世界的使用模式（例如，用户很少查看前几个结果之后的内容）

    关键概念包括：
    - **相关项目（Relevant Item）**：根据预定义标准与给定文本查询适当匹配的音乐作品
    - **Top K 结果**：检索系统返回的排名最高的 K 个项目
    - **预测标签（Predicted Label）**：二值指示符（0/1），表示系统是否将某个项目排在前 K 位
    - **实际标签（Actual Label）**：表示某个项目是否应被视为相关的真实标签二值指示符

```{figure} ./img/eval_confusion.png
---
name: Confusion Matrix
---
```

3. **评估预测结果**：将系统预测与真实标签进行比较，以识别四个关键类别：
   - 真正例（True Positives, TP）：正确排在前 K 位的相关项目
   - 假正例（False Positives, FP）：错误排在前 K 位的不相关项目
   - 真负例（True Negatives, TN）：正确排在前 K 位之后的不相关项目
   - 假负例（False Negatives, FN）：错误排在前 K 位之后的相关项目

4. **计算指标**：使用这些计数来计算标准评估指标：
   - 精确率和召回率，用于整体准确性评估
   - 基于排名的指标如 MAP@K 和 MRR，用于排名质量评估

### 精确率和召回率

精确率（Precision）和召回率（Recall）是提供系统性能互补信息的基本指标：

**精确率**：检索到的项目中相关项目的比例
- 更高的精确率意味着前 K 个结果中不相关结果更少
- 对用户满意度至关重要，因为它衡量的是结果质量


**召回率**：相关项目中被检索到的比例
- 更高的召回率意味着遗漏的相关项目更少
- 对于全面检索任务很重要

$$
\text{Precision} = \frac{\text{True Positives}}{\text{True Positives + False Positives}}
$$

$$
\text{Recall} = \frac{\text{True Positives}}{\text{True Positives + False Negatives}}
$$

**平均精确率均值（Mean Average Precision, MAP@K）**
- 衡量多个查询的平均精确率，仅考虑前 K 个结果
- 强调在排名靠前的位置返回相关项目，其中 AP@K 是单个查询在 K 处的平均精确率
- 值的范围从 0 到 1，1 表示完美排名

$$
\text{MAP@K} = \frac{1}{|Q|} \sum_{q=1}^{|Q|} \text{AP@K}(q)
$$

**平均倒数排名（Mean Reciprocal Rank, MRR）**
- 每个查询第一个相关结果的倒数排名的平均值
- 关注系统能多快返回至少一个相关结果，其中 rank_q 是查询 q 的第一个相关结果的位置
- 对于找到第一个相关结果至关重要的任务特别有用

$$
\text{MRR} = \frac{1}{|Q|} \sum_{q=1}^{|Q|} \frac{1}{\text{rank}_q}
$$


**中位排名（Median Rank）**
- 排名结果中相关项目的中位位置
- 提供了集中趋势的稳健度量
- 与平均排名相比，对异常值不太敏感
- 较低的值表示更好的性能


$$
\text{Median Rank} = \text{median}(\text{rank}_1, \text{rank}_2, \ldots, \text{rank}_n)
$$

通过仔细考虑这些评估指标和实践，研究人员和从业者可以更好地理解和提升音乐检索系统的性能。使用这些综合指标进行定期评估有助于确保系统满足用户需求，并在不同场景下可靠运行。
